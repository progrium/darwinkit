package generate

import (
	"bufio"
	"fmt"
	"io/fs"
	"log"
	"os"
	"os/exec"
	"path/filepath"
	"strings"

	"github.com/progrium/macdriver/generate/codegen"
)

func RemoveGeneratedCode(dir string) {
	filepath.WalkDir(dir, func(path string, d fs.DirEntry, err error) error {
		if d.Type().IsRegular() {
			f, _ := os.Open(path)
			defer f.Close()
			scanner := bufio.NewScanner(f)
			if scanner.Scan() {
				line := strings.TrimSpace(scanner.Text())
				if line == strings.TrimSpace(codegen.AutoGeneratedMark) {
					os.Remove(path)
				}
			}
		}
		return err
	})
}

func FormatCode(dir string) {
	//log.Println("formating go code...")
	cmd := exec.Command("goimports", "-w", dir)
	out, err := cmd.CombinedOutput()

	if err != nil {
		log.Println("format code error:", err.Error())
		fmt.Println(string(out))
		return
	}

	fmt.Println(string(out))
}
